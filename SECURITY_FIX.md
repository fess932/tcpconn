# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ API —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

## –ü—Ä–æ–±–ª–µ–º–∞

–í –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±—ã–ª –º–µ—Ç–æ–¥:

```go
func (c *TCPConnection) GetStatistics() *Statistics {
    c.mu.RLock()
    defer c.mu.RUnlock()
    return c.stats  // ‚ùå –ù–ï–ë–ï–ó–û–ü–ê–°–ù–û!
}
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞?

1. **–û–±—Ö–æ–¥ –∑–∞—â–∏—Ç—ã –æ—Ç race conditions**: –ú–µ—Ç–æ–¥ –±–ª–æ–∫–∏—Ä—É–µ—Ç –º—å—é—Ç–µ–∫—Å (`c.mu.RLock()`), 
   –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ–±—ä–µ–∫—Ç. –ü–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ 
   —Å–Ω–∏–º–∞–µ—Ç—Å—è, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏–º–µ—Ç—å –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ `c.stats`.

2. **–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø**: –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–∏—à–µ—Ç –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–≤—ã–∑—ã–≤–∞—è `Write()`),
   –∞ –¥—Ä—É–≥–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞ —á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ –≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å, –≤–æ–∑–Ω–∏–∫–∞–µ—Ç
   race condition.

3. **–ò–ª–ª—é–∑–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**: Lock —Å–æ–∑–¥–∞—ë—Ç –ª–æ–∂–Ω–æ–µ –æ—â—É—â–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —Ö–æ—Ç—è
   —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–∞—â–∏—Ç—ã –Ω–µ—Ç.

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:

```go
// –ì–æ—Ä—É—Ç–∏–Ω–∞ 1
stats := conn.GetStatistics()  // –ü–æ–ª—É—á–∏–ª–∏ —É–∫–∞–∑–∞—Ç–µ–ª—å
// Lock —É–∂–µ —Å–Ω—è—Ç!

// –ì–æ—Ä—É—Ç–∏–Ω–∞ 2
conn.Write(data)  // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç stats –≤–Ω—É—Ç—Ä–∏

// –ì–æ—Ä—É—Ç–∏–Ω–∞ 1 –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç
rate := stats.GetSendRate()  // ‚ö†Ô∏è RACE CONDITION!
```

## –†–µ—à–µ–Ω–∏–µ

### 1. –£–¥–∞–ª—ë–Ω –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥ GetStatistics()

–ú–µ—Ç–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—ë–Ω –∏–∑ API.

### 2. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ #1: GetStatisticsSnapshot()

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö, –∞ –Ω–µ —É–∫–∞–∑–∞—Ç–µ–ª—å:

```go
func (c *TCPConnection) GetStatisticsSnapshot() Snapshot {
    c.mu.RLock()
    defer c.mu.RUnlock()
    return c.stats.GetSnapshot()  // ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ø–∏—é
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```go
snapshot := conn.GetStatisticsSnapshot()
// snapshot - —ç—Ç–æ –∫–æ–ø–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
fmt.Printf("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: %d\n", snapshot.PacketsSent)
```

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ #2: NewTCPConnectionWithStats()

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –æ–±—ä–µ–∫—Ç—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –ø–µ—Ä–µ–¥–∞–π—Ç–µ –µ–≥–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:

```go
// –°–æ–∑–¥–∞—ë–º –≤–Ω–µ—à–Ω–∏–π –æ–±—ä–µ–∫—Ç
stats := tcpconn.NewStatistics()

// –ü–µ—Ä–µ–¥–∞—ë–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
conn, _ := tcpconn.NewTCPConnectionWithStats(4096, stats)

// –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å stats –Ω–∞–ø—Ä—è–º—É—é
packets := stats.GetPacketsSent()
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–∞
- –ú–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª—è—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–µ–∂–¥—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

## –ú–∏–≥—Ä–∞—Ü–∏—è –∫–æ–¥–∞

### –î–æ (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ):
```go
conn, _ := tcpconn.NewTCPConnection(4096)
stats := conn.GetStatistics()  // ‚ùå –ë–æ–ª—å—à–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
packets := stats.GetPacketsSent()
```

### –ü–æ—Å–ª–µ (–≤–∞—Ä–∏–∞–Ω—Ç 1 - snapshot):
```go
conn, _ := tcpconn.NewTCPConnection(4096)
snapshot := conn.GetStatisticsSnapshot()  // ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ
packets := snapshot.PacketsSent
```

### –ü–æ—Å–ª–µ (–≤–∞—Ä–∏–∞–Ω—Ç 2 - –≤–Ω–µ—à–Ω–∏–π –æ–±—ä–µ–∫—Ç):
```go
stats := tcpconn.NewStatistics()
conn, _ := tcpconn.NewTCPConnectionWithStats(4096, stats)
packets := stats.GetPacketsSent()  // ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ, –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ stats
```

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –ø–æ–¥—Ö–æ–¥

### GetStatisticsSnapshot() - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–≥–¥–∞:
- ‚úÖ –ù—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ —á–∞—Å—Ç–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
- ‚úÖ –•–æ—Ç–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ—Ç—É –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### NewTCPConnectionWithStats() - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–≥–¥–∞:
- ‚úÖ –ù—É–∂–Ω–∞ –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- ‚úÖ –ù—É–∂–µ–Ω —á–∞—Å—Ç—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ (–º–µ–Ω—å—à–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–π)
- ‚úÖ –ù—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ –ì–æ—Ç–æ–≤—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: 
   - STATISTICS.md
   - STATISTICS_QUICK.txt
   - –í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –ø–µ—Ä–µ–ø–∏—Å–∞–Ω—ã

2. **–î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã**:
   - TestTCPConnection_WithExternalStats
   - TestTCPConnection_WithNilStats

3. **–ü–æ–∫—Ä—ã—Ç–∏–µ**: —É–≤–µ–ª–∏—á–µ–Ω–æ —Å 89.0% –¥–æ 89.5%

## Best Practices

1. **–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π—Ç–µ snapshot**: –í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `GetStatisticsSnapshot()`
2. **–ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏**: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã
3. **–Ø–≤–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ**: –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –≤–Ω–µ—à–Ω–∏–π –æ–±—ä–µ–∫—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, —è–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –µ–≥–æ –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏
4. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ**: –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—ë—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏, –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∫—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

## –í—ã–≤–æ–¥—ã

–≠—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ - —Ö–æ—Ä–æ—à–∏–π –ø—Ä–∏–º–µ—Ä —Ç–æ–≥–æ, –ø–æ—á–µ–º—É –≤–∞–∂–Ω–æ:
- ‚úÖ –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å API —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å defensive copying –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
- ‚úÖ –î–µ–ª–∞—Ç—å –≤–ª–∞–¥–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞–º–∏ —è–≤–Ω—ã–º

–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã! üôè
